# go VNC

**go VNC** is a Go-based project that integrates [vncproxy](https://github.com/amitbet/vncproxy) and [vnc2video](https://github.com/amitbet/vnc2video), with a custom wrapper to handle OpenStack authentication, acquisition of VNC credentials, and setup of WebSocket connections for recording OpenStack virtual machines (VMs). The project exposes a REST API to record specific VMs, with videos stored in a minio bucket, automatically generated by worker, for retrieval.

## Features

- **OpenStack Integration**: Handles authentication with OpenStack and acquires the necessary VNC credentials.
- **VNC Recording**: Leverages `vncproxy` and `vnc2video` for capturing and recording VNC sessions as mp4 files with specified duration.
- **WebSocket Setup**: Automatically establishes WebSocket connections for VNC sessions and recording.
- **REST API**: Provides a REST API to specify which OpenStack VM to record and returns a bucket ID containing the recorded video when ready.

## Repository

[GitHub Repository](https://github.com/blueBye/goVNC)

## Requirements

- Docker
- OpenStack environment with access to APIs
- MinIO

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/blueBye/goVNC.git
   cd goVNC
   ```

2. Build the Docker container:
   ```bash
   make build
   ```

This command will create a Docker container that acts as a lightweight server, waiting for incoming REST API calls to start the VNC recording process.

## Usage

To start the server and make it available for REST API requests, run:

```bash
make run
```

The server will run in a Docker container, listening for API requests to begin recording VNC sessions for specific OpenStack VMs.


### REST API Format

To start recording, send a POST request to `/record` with the following payload:
- `server:` ID of the server you want to record 
- `duration:` duration of a single recording in seconds
- `count:` number of recordings

```bash
curl -X POST http://127.0.0.1:8090/record \
     -H "Accept: application/json" \
     --data '{
      "server":"ed26df05-df05-4048-b02d-dd67ee401138",
      "duration":20,
      "count":10
    }'
```

In response, you'll receive a `bucket_id` containing the video when the recording is complete.


## Makefile Commands

The `Makefile` simplifies development and deployment tasks for the **go VNC** project. Below is a description of each command:

Here are the descriptions for the specified `Makefile` commands:

- **watch**:  
  Continuously watches the `./FBS` directory and updates the list of files every second. Useful for monitoring new files as they are created.

  ```bash
  watch -n 1 ls -lh ./FBS
  ```

- **build**:  
  Builds and starts the Docker container in detached mode, updating the service with any changes. This is the primary command to get the server running after making changes.

  ```bash
  sudo docker compose up -d --build
  ```

- **logs**:  
  Displays live logs of the `vnc_recorder` service, helping you monitor the container's activities as it runs.

  ```bash
  sudo docker compose logs -f vnc_recorder
  ```

- **finit-logs**:  
  Fetches the logs for the `vnc_recorder` service without live streaming, useful for piping logs through multiple commands.

  ```bash
  sudo docker compose logs vnc_recorder
  ```

- **exec**:  
  Opens an interactive shell inside the running `vnc_recorder` container, allowing you to execute commands inside the container for debugging or inspection.

  ```bash
  sudo docker compose exec -it vnc_recorder sh
  ```

- **down**:  
  Stops and removes all containers, networks, and volumes associated with the Docker Compose setup.

  ```bash
  sudo docker compose down
  ```

- **pull**:  
  Pulls the latest version of the `golang:1.22-alpine3.19` Docker image. This is useful if you're working with a specific base image and want to ensure it's up to date.

  ```bash
  sudo docker pull golang:1.22-alpine3.19
  ```

- **clean**:  
  Deletes all files in the `./FBS` directory, which is likely where the recorded files are stored.

  ```bash
  sudo rm -f FBS/*
  ```

- **prune**:  
  Cleans up unused Docker builder cache, helping free up space by removing dangling resources that are no longer in use.

  ```bash
  sudo docker builder prune
  ```

- **debug**:  
  Cleans the `FBS` directory and brings down the existing Docker container, then rebuilds and restarts the container. After a brief pause, it sends a POST request to start recording on a specific server (my local test server) with a duration of 20 seconds and a repeat count of 10.

  ```bash
  clean down
  sleep 1
  sudo docker compose up -d --build
  sleep 1
  curl http://127.0.0.1:8090/record -X POST --data '{"server":"ed26df05-df05-4048-b02d-dd67ee401138","duration":20,"count":10}' -H "Accept: application/json"
  ```

- **log-file**:  
  Writes the logs of the `vnc_recorder` service to a file called `1.log` in the `goVNC` directory.

  ```bash
  sudo docker compose logs vnc_recorder > goVNC/1.log
  ```

## Project Structure

```
│   .gitignore              # Files and directories to be ignored by Git
│   build_linux.ps1         # Script for setting golang environment variables used for building vnc3video on Windows for Linux systems using PowerShell
│   docker-compose.yml      # Docker Compose configuration file for managing containers
│   Makefile                # Makefile for automating build, run, and other tasks
│   README.md               # Project documentation
│
└───goVNC
        Dockerfile          # Dockerfile to build the goVNC container
        ffmpeg              # Binary or scripts related to FFmpeg, used for video processing (needed due to implementation of vnc2video)
        generateFBS.go      # Go code to generate Framebuffer Stream (FBS) files
        generateVideo.go    # Go code to convert FBS to video format
        getRemoteConsole.go # Go code to retrieve VNC credentials from OpenStack
        go.mod              # Go module file for managing dependencies
        go.sum              # Checksum file for dependencies
        main.go             # Main entry point for the goVNC application
        rwc.go              # Handles reading, writing, and closing streams during VNC recording (websocket wrapper)
        upload.go           # Go code to upload recorded videos to a minio bucket
        vnc2video           # binary build of vnc2video for Linux operating system
```

## Contributing

Contributions are welcome! Please follow the standard GitHub pull request process:

1. Fork the repository.
2. Create a new branch.
3. Make your changes.
4. Submit a pull request.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for more details.

## Knowen Issues and Improvements
- [ ] recorder works fine on graphical desktops but not so well when dealing with terminal and CLI
- [ ] there is a few second lag between videos due to time required to acquire remote access to openstack and RFB handshake
- [ ] code structure is all over the place
- [ ] recording resolution is not so good and can't be set by REST API
- [ ] vnc2video requires ffmpeg to be installed on system and also a binary should be placed right next to vnc2video binary
- [ ] we really need some tests (there were some rfb files on tightvnc website but vnc2video lacked encoders)
- [ ] we really need some documentation on FBS format used here (i just know it's compatible with tightvnc)
- [ ] setup guide for developers is needed (I used proxmox to setup VNC server when debugging, and didn't mange to use guacamoli thing)
- [ ] vncproxy and vnv2video codes lack documentations and code structure is a bit odd (took me a few months to figure it out)
